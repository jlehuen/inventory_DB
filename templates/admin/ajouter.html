<!-- templates/admin/ajouter.html -->
{% extends 'base.html' %}

{% block title %}Ajouter un objet - Gestion de la collection{% endblock %}

{% block content %}
<section class="admin-form-section">
    <h1>Ajouter un nouvel objet</h1>

    <form method="post" enctype="multipart/form-data" class="admin-form">
        <div class="form-group">
            <label for="nom">Nom (ou titre) *</label>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" id="nom" name="nom" value="{{ objet.nom or '' }}" required>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="5">{{ objet.description or '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="categorie">Catégorie *</label>
            <select id="categorie" name="categorie" required>
                <option value="">-- Sélectionner une catégorie --</option>
                <!-- Les options seront générées dynamiquement par JavaScript -->
            </select>
            <small>La catégorie détermine quels champs supplémentaires sont disponibles</small>
        </div>

        <div class="form-group" id="autre-categorie-container" style="display: none;">
            <label for="autre-categorie">Préciser la catégorie *</label>
            <input type="text" id="autre-categorie" name="autre-categorie" value="{{ objet.categorie if objet.categorie and objet.categorie not in ['Ordinateur', 'Console de jeu', 'Périphérique', 'Appareil photo'] else '' }}">
        </div>

        <div class="form-group">
            <label for="fabricant">Fabricant (ou éditeur)</label>
            <input type="text" id="fabricant" name="fabricant" value="{{ objet.fabricant or '' }}">
        </div>

        <div class="form-group">
            <label for="date_fabrication">Année de sortie (ou d'édition)</label>
            <input type="text" id="date_fabrication" name="date_fabrication" value="{{ objet.date_fabrication or '' }}">
        </div>

        <div class="form-group liens-supplementaires">
            <label>Informations (URL)</label>
            <div class="liens-upload-container" id="liens-container">
                <div class="lien-upload-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="url" name="liens" placeholder="https://..." style="flex-grow: 1;">
                    <!-- On ne met pas de bouton supprimer sur le premier champ obligatoire -->
                </div>
            </div>
            <button type="button" class="btn" style="padding: 0.4rem 1rem; font-size: 0.85rem;" onclick="ajouterChampLien()">+ Ajouter un lien</button>
            <br><small>Entrez des URL complètes (ex: https://exemple.com)</small>
        </div>

        <div class="form-group">
            <label for="numero_inventaire">Numéro d'inventaire *</label>
            <input type="text" id="numero_inventaire" name="numero_inventaire" value="{{ objet.numero_inventaire or '' }}" required readonly class="readonly-input">
            <small>Ce numéro est généré automatiquement et ne peut pas être modifié</small>
        </div>

        <div class="form-group">
            <label for="origine">Origine / Donateur</label>
            <input type="text" id="origine" name="origine" class="form-control" value="{{ objet['origine']|default('') }}" placeholder="Ex: Don de M. Dupont, Achat Brocante...">
            <small class="form-help">Information confidentielle (visible uniquement par les administrateurs)</small>
        </div>

        <div class="form-group">
            <label for="etat">État de l'objet</label>
            <input type="text" id="etat" name="etat" value="{{ objet.etat or '' }}">
            <small>Décrivez l'état actuel de l'objet (ex: Bon état, Défectueux, etc.)</small>
        </div>

        <div class="form-group">
            <h3>Champs spécifiques à la catégorie</h3>
            <br/>
            <div id="attributs-specifiques-container">
                <!-- Les champs spécifiques seront injectés ici par JavaScript -->
            </div>
        </div>

        <div class="form-group">
            <label for="image_principale">Image principale</label>
            <input type="file" id="image_principale" name="image_principale" accept="image/*">
        </div>

        <div class="form-group images-supplementaires">
            <label>Images supplémentaires</label>
            <div class="image-upload-container" id="images-container">
                <div class="image-upload-item">
                    <input type="file" name="images_supplementaires" accept="image/*">
                    <input type="text" name="legende_0" placeholder="Légende (optionnelle)">
                    <button type="button" class="btn-small" onclick="ajouterChampImage()">+</button>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('collection') }}" class="btn secondary">Annuler</a>
            <button type="submit" class="btn primary">Ajouter</button>
        </div>
    </form>
</section>

<script>
    // Variable pour stocker les attributs chargés depuis le JSON
    let categorieAttributs = {};

    // Fonction pour remplir le sélecteur de catégories à partir du JSON
    function remplirCategories() {
        const categorieSelect = document.getElementById('categorie');
        const categorieValue = categorieSelect.value; // Sauvegarder la valeur actuelle

        // Vider le sélecteur sauf l'option par défaut
        while (categorieSelect.options.length > 1) {
            categorieSelect.remove(1);
        }

        // Ajouter une option pour chaque catégorie du JSON
        for (const categorie in categorieAttributs) {
            const option = document.createElement('option');
            option.value = categorie;
            option.textContent = categorie;
            categorieSelect.appendChild(option);
        }

        // Ajouter l'option "Autre"
        const autreOption = document.createElement('option');
        autreOption.value = 'Autre';
        autreOption.textContent = 'Autre';
        categorieSelect.appendChild(autreOption);

        // Restaurer la valeur sélectionnée si elle existe
        if (categorieValue) {
            categorieSelect.value = categorieValue;
        }

        // Pour l'initialisation, préselectionner la catégorie si elle vient du serveur
        {% if objet.categorie %}
            if (Array.from(categorieSelect.options).some(opt => opt.value === "{{ objet.categorie }}")) {
                categorieSelect.value = "{{ objet.categorie }}";
            } else if ("{{ objet.categorie }}" && !["", "Autre"].includes("{{ objet.categorie }}")) {
                categorieSelect.value = "Autre";
                document.getElementById('autre-categorie').value = "{{ objet.categorie }}";
                toggleAutreCategorie();
            }
        {% endif %}
    }

    // Fonction pour charger les attributs depuis le fichier JSON
    async function chargerDefinitionsAttributs() {
        try {
            const response = await fetch('/static/categories.json');

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const categoriesData = await response.json();

            // Adapter au nouveau format JSON (extraire uniquement les attributs)
            categorieAttributs = {};
            for (const categorie in categoriesData) {
                if (categoriesData[categorie].attributes) {
                    categorieAttributs[categorie] = categoriesData[categorie].attributes;
                }
            }

            // Remplir le sélecteur de catégories
            remplirCategories();

            // Initialiser les champs du formulaire
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        } catch (error) {
            console.error("Erreur lors du chargement des définitions d'attributs:", error);
            // En cas d'erreur, on définit un objet vide
            categorieAttributs = {};
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        }
    }

    // Fonction pour charger les attributs spécifiques selon la catégorie
    function chargerAttributsSpecifiques() {
        const categorie = document.getElementById('categorie').value;
        const container = document.getElementById('attributs-specifiques-container');

        // Vider le conteneur
        container.innerHTML = '';

        // Gérer le cas "Autre" et les catégories sans attributs spécifiques définis
        if (categorie === 'Autre' || !categorieAttributs[categorie]) {
            container.innerHTML = '<p>Aucun attribut spécifique disponible pour cette catégorie</p>';
            return;
        }

        // Créer les champs pour chaque attribut
        categorieAttributs[categorie].forEach(attr => {
            const divElement = document.createElement('div');
            divElement.className = 'form-group';

            const labelElement = document.createElement('label');
            labelElement.setAttribute('for', `attr_${attr.id}`);
            labelElement.textContent = attr.label;

            const inputElement = document.createElement('input');
            inputElement.setAttribute('type', attr.type);
            inputElement.setAttribute('id', `attr_${attr.id}`);
            inputElement.setAttribute('name', `attr_${attr.id}`);

            // Ajouter un champ caché pour l'ordre
            const orderInput = document.createElement('input');
            orderInput.setAttribute('type', 'hidden');
            orderInput.setAttribute('name', `attr_ordre_${attr.id}`);
            orderInput.setAttribute('value', attr.ordre);

            // Ajouter un champ caché pour le label
            const labelInput = document.createElement('input');
            labelInput.setAttribute('type', 'hidden');
            labelInput.setAttribute('name', `attr_label_${attr.id}`);
            labelInput.setAttribute('value', attr.label);

            // Pour le formulaire d'ajout, précharger les valeurs si elles existent
            {% if objet.attributs_specifiques %}
                try {
                    const attributsSpecifiques = JSON.parse('{{ objet.attributs_specifiques|tojson }}');
                    if (attributsSpecifiques && attributsSpecifiques[attr.id]) {
                        if (typeof attributsSpecifiques[attr.id] === 'object' && attributsSpecifiques[attr.id] !== null) {
                            // Si c'est un objet avec une propriété 'valeur', utiliser cette valeur
                            if ('valeur' in attributsSpecifiques[attr.id]) {
                                inputElement.value = attributsSpecifiques[attr.id].valeur;
                            }
                            // Sinon, utiliser une chaîne vide pour éviter [object Object]
                            else {
                                inputElement.value = '';
                                console.warn(`Format incorrect pour l'attribut ${attr.id}:`, attributsSpecifiques[attr.id]);
                            }
                        } else {
                            // Pour les valeurs non-objet (string, number, etc.)
                            inputElement.value = attributsSpecifiques[attr.id] || '';
                        }
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement des attributs spécifiques", e);
                }
            {% endif %}

            divElement.appendChild(labelElement);
            divElement.appendChild(inputElement);
            divElement.appendChild(orderInput);
            divElement.appendChild(labelInput);
            container.appendChild(divElement);
        });
    }

    // Gérer l'affichage du champ "Autre catégorie"
    function toggleAutreCategorie() {
        const categorieSelect = document.getElementById('categorie');
        const autreCategorieContainer = document.getElementById('autre-categorie-container');

        if (categorieSelect.value === 'Autre') {
            autreCategorieContainer.style.display = 'block';
            document.getElementById('autre-categorie').setAttribute('required', 'required');
        } else {
            autreCategorieContainer.style.display = 'none';
            document.getElementById('autre-categorie').removeAttribute('required');
        }
    }

    let imageIndex = 1;

    function ajouterChampImage() {
        const container = document.getElementById('images-container');
        const newItem = document.createElement('div');
        newItem.className = 'image-upload-item';

        newItem.innerHTML = `
            <input type="file" name="images_supplementaires" accept="image/*">
            <input type="text" name="legende_${imageIndex}" placeholder="Légende (optionnelle)">
            <button type="button" class="btn-small danger" onclick="supprimerChampImage(this)">-</button>
        `;

        container.appendChild(newItem);
        imageIndex++;
        
        // Activer le Drag & Drop sur le nouveau champ
        if (typeof enhanceFileUploads === 'function') {
            enhanceFileUploads();
        }
    }

    function supprimerChampImage(button) {
        const item = button.parentElement;
        item.remove();
    }

    // Gestion des liens dynamiques
    function ajouterChampLien() {
        const container = document.getElementById('liens-container');
        const newItem = document.createElement('div');
        newItem.className = 'lien-upload-item';
        newItem.style.cssText = "display: flex; gap: 10px; margin-bottom: 10px; align-items: center;";

        newItem.innerHTML = `
            <input type="url" name="liens" placeholder="https://..." style="flex-grow: 1;">
            <button type="button" class="btn-small danger" onclick="supprimerChampLien(this)">-</button>
        `;

        container.appendChild(newItem);
    }

    function supprimerChampLien(button) {
        const item = button.parentElement;
        item.remove();
    }

    // Initialiser les éléments au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const categorieSelect = document.getElementById('categorie');
        const form = document.querySelector('form');

        // Charger les définitions d'attributs
        chargerDefinitionsAttributs();

        // Écouter les changements de catégorie
        categorieSelect.addEventListener('change', function() {
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        });

        // Intercepter la soumission du formulaire pour gérer "Autre catégorie"
        form.addEventListener('submit', function(e) {
            if (categorieSelect.value === 'Autre') {
                const autreCategorie = document.getElementById('autre-categorie').value.trim();
                if (autreCategorie) {
                    e.preventDefault(); // Empêcher la soumission standard

                    // Créer un champ caché pour la catégorie personnalisée
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'categorie_personnalisee';
                    hiddenInput.value = autreCategorie;
                    form.appendChild(hiddenInput);

                    // Soumettre le formulaire
                    form.submit();
                }
            }
        });
    });
</script>
{% endblock %}
