{% extends 'base.html' %}

{% block title %}Gestion des Liens - Administration{% endblock %}

{% block content %}
<div class="admin-container" style="max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px 20px;">
    
    <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px;">
        <h1 style="color: #2c3e50; margin: 0;"><i class="fas fa-link"></i> Éditeur de Liens</h1>
    </div>

    <!-- Zone d'erreur JS visible -->
    <div id="js-error-zone" style="display:none; padding: 20px; background: #fee; color: #c0392b; border: 1px solid #e74c3c; border-radius: 4px; margin-bottom: 20px; white-space: pre-wrap; font-family: monospace;"></div>

    <form method="POST" id="main-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Ce champ caché reçoit le JSON final -->
        <textarea name="json_content" id="json-output" style="display:none;">{% if raw_json_for_editing %}{{ raw_json_for_editing }}{% endif %}</textarea>

        <!-- Conteneur de l'application -->
        <div id="editor-container">
            <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>Chargement de l'interface...
            </div>
        </div>

        <!-- Barre d'actions fixe en bas -->
        <div class="form-actions-sticky" style="position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; padding: 15px 20px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 1000;">
            <a href="{{ url_for('liens') }}" style="background: #95a5a6; color: white; border-radius: 4px; text-decoration: none; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 220px; height: 50px; box-sizing: border-box; border: none; padding: 0 25px;">
                <i class="fas fa-times"></i> Annuler
            </a>

            <button type="submit" style="background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 220px; height: 50px; box-sizing: border-box; padding: 0 25px;">
                <i class="fas fa-save"></i> Enregistrer
            </button>

            <button type="button" id="btn-add-cat" style="background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 220px; height: 50px; box-sizing: border-box; padding: 0 25px;">
                <i class="fas fa-plus-circle"></i> Catégorie
            </button>
        </div>
    </form>
</div>

<!-- Ajout de SortableJS depuis un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
(function() {
    // Gestionnaire d'erreur global pour cette page
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        var errorZone = document.getElementById('js-error-zone');
        if (errorZone) {
            errorZone.style.display = 'block';
            errorZone.innerHTML = '<strong>Erreur JavaScript :</strong><br>' + msg + '<br>Ligne : ' + lineNo;
            console.error('Erreur capturée :', error);
        }
        return false;
    };

    try {
        console.log("Démarrage de l'éditeur de liens...");

        // 1. Initialisation des données
        var initialData = [];
        try {
            {% if liens_data is defined and liens_data is not none %}
                initialData = {{ liens_data | tojson | safe }};
            {% endif %}
        } catch (e) {
            console.error("Erreur lors de l'injection des données serveur :", e);
            throw new Error("Impossible de lire les données initiales du serveur.");
        }

        // Sécurité : fallback sur un tableau vide
        if (!initialData || !Array.isArray(initialData)) {
            console.warn("Données initiales vides ou invalides, démarrage à vide.");
            initialData = [];
        }

        // État global de l'application (Single Source of Truth)
        var appState = JSON.parse(JSON.stringify(initialData)); // Deep copy simple

        // Références DOM
        var container = document.getElementById('editor-container');
        var outputField = document.getElementById('json-output');
        var btnAddCat = document.getElementById('btn-add-cat');
        var form = document.getElementById('main-form');
        
        // Si du JSON brut (invalide) est passé, on essaie de le charger
        if (outputField.value.trim()) {
            try {
                appState = JSON.parse(outputField.value.trim());
            } catch(e) {
                console.error("JSON brut invalide dans le textarea:", e);
                var errorZone = document.getElementById('js-error-zone');
                errorZone.style.display = 'block';
                errorZone.innerHTML = `<strong>Erreur de syntaxe JSON détectée :</strong><br>Le JSON que vous avez soumis est malformé. Veuillez le corriger.<br><br><i>${e.message}</i>`;
            }
        }


        // --- Moteur de Rendu ---

        function render() {
            // Sauvegarde l'état actuel dans le champ caché à chaque rendu
            updateOutput();

            // Vide le conteneur
            container.innerHTML = '';

            if (appState.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 50px 20px; color: #95a5a6; background: #f8f9fa; border: 2px dashed #bdc3c7; border-radius: 8px;">
                        <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i><br>
                        <h3>Aucune catégorie</h3>
                        <p>Cliquez sur "Nouvelle Catégorie" en bas pour commencer.</p>
                    </div>
                `;
                return;
            }

            // Génère le HTML pour chaque catégorie
            appState.forEach(function(category, catIndex) {
                var catBlock = document.createElement('div');
                catBlock.className = 'cat-block';
                catBlock.dataset.catIndex = catIndex; // Pour SortableJS
                catBlock.style.cssText = 'background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden;';

                // En-tête de catégorie
                var header = document.createElement('div');
                header.style.cssText = 'background: #f1f4f6; padding: 15px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; gap: 15px;';
                header.innerHTML = `
                    <div style="flex-grow: 1; display: flex; align-items: center; gap: 10px;">
                        <div class="drag-handle" style="color: #34495e; cursor: move;"><i class="fas fa-grip-vertical"></i></div>
                        <div style="flex-grow: 1;">
                            <input type="text" class="input-cat-name" value="${escapeHtml(category.categorie || '')}"
                                   style="width: 100%; font-size: 1.1em; font-weight: bold; border: 1px solid #ccc; padding: 8px; border-radius: 4px;"
                                   placeholder="Ex: Bases de données">
                        </div>
                    </div>
                    <button type="button" class="btn-delete-cat" title="Supprimer cette catégorie" style="background: white; border: 1px solid #e74c3c; color: #e74c3c; width: 36px; height: 36px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                
                // Événements En-tête
                header.querySelector('.input-cat-name').oninput = function(e) {
                    appState[catIndex].categorie = e.target.value;
                    updateOutput(); // Mise à jour silencieuse du champ caché
                };
                
                header.querySelector('.btn-delete-cat').onclick = function() {
                    if(confirm("Supprimer la catégorie \"" + (appState[catIndex].categorie || 'Sans nom') + "\" et tous ses liens ?")) {
                        appState.splice(catIndex, 1);
                        render();
                    }
                };

                catBlock.appendChild(header);

                // Liste des liens
                var linksContainer = document.createElement('div');
                linksContainer.className = 'links-container';
                linksContainer.dataset.catIndex = catIndex; // Pour retrouver la catégorie parente
                linksContainer.style.cssText = 'padding: 15px; background: #fff;';

                if (!category.liens || category.liens.length === 0) {
                    linksContainer.innerHTML = '<div style="text-align: center; color: #bdc3c7; padding: 10px; font-style: italic;">Aucun lien dans cette catégorie</div>';
                } else {
                    category.liens.forEach(function(link, linkIndex) {
                        var linkRow = document.createElement('div');
                        linkRow.className = 'link-row';
                        linkRow.dataset.linkIndex = linkIndex; // Pour SortableJS
                        linkRow.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; align-items: flex-start;';
                        
                        linkRow.innerHTML = `
                            <div style="flex-shrink: 0; padding-right: 10px; color: #bdc3c7; cursor: move;"><i class="fas fa-grip-lines"></i></div>
                            <div style="flex: 1 1 200px; display: flex; flex-direction: column; gap: 8px;">
                                <input type="text" class="input-link-nom" value="${escapeHtml(link.nom || '')}" placeholder="Nom du site" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-weight: 500;">
                                <input type="text" class="input-link-url" value="${escapeHtml(link.url || '')}" placeholder="URL (https://...)" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #2980b9; font-family: monospace;">
                            </div>
                            <div style="flex: 2 1 300px;">
                                <textarea class="input-link-desc" placeholder="Description courte..." rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 76px;">${escapeHtml(link.description || '')}</textarea>
                            </div>
                            <button type="button" class="btn-delete-link" title="Supprimer ce lien" style="background: none; border: none; color: #95a5a6; cursor: pointer; padding: 5px; margin-top: 5px;">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

                        // Événements Lien
                        linkRow.querySelector('.input-link-nom').oninput = function(e) {
                            appState[catIndex].liens[linkIndex].nom = e.target.value;
                            updateOutput();
                        };
                        linkRow.querySelector('.input-link-url').oninput = function(e) {
                            appState[catIndex].liens[linkIndex].url = e.target.value;
                            updateOutput();
                        };
                        linkRow.querySelector('.input-link-desc').oninput = function(e) {
                            appState[catIndex].liens[linkIndex].description = e.target.value;
                            updateOutput();
                        };
                        linkRow.querySelector('.btn-delete-link').onclick = function() {
                            appState[catIndex].liens.splice(linkIndex, 1);
                            render(); // Re-render nécessaire car on supprime un élément du tableau
                        };

                        linksContainer.appendChild(linkRow);
                    });
                }

                catBlock.appendChild(linksContainer);

                // Footer (Bouton Ajout Lien)
                var footer = document.createElement('div');
                footer.style.cssText = 'padding: 10px 15px; background: #fcfcfc; border-top: 1px solid #f0f0f0;';
                
                var btnAddLink = document.createElement('button');
                btnAddLink.type = 'button';
                btnAddLink.innerHTML = '<i class="fas fa-plus"></i> Ajouter un lien';
                btnAddLink.style.cssText = 'background: none; border: none; color: #3498db; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 4px;';
                btnAddLink.onmouseover = function() { this.style.backgroundColor = '#ebf5fb'; };
                btnAddLink.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                
                btnAddLink.onclick = function() {
                    if (!appState[catIndex].liens) appState[catIndex].liens = [];
                    appState[catIndex].liens.push({ nom: '', url: '', description: '' });
                    render();
                };

                footer.appendChild(btnAddLink);
                catBlock.appendChild(footer);

                container.appendChild(catBlock);
            });

            // Initialiser SortableJS après le rendu
            initSortable();
        }

        // --- SortableJS ---

        function initSortable() {
            // Pour les catégories
            new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function(evt) {
                    var itemEl = evt.item; // L'élément déplacé
                    var oldIndex = evt.oldIndex;
                    var newIndex = evt.newIndex;

                    // Mettre à jour l'ordre dans appState
                    var movedItem = appState.splice(oldIndex, 1)[0];
                    appState.splice(newIndex, 0, movedItem);

                    // Re-render pour que tout soit propre
                    render();
                }
            });

            // Pour les liens dans chaque catégorie
            document.querySelectorAll('.links-container').forEach(function(linksContainer) {
                new Sortable(linksContainer, {
                    animation: 150,
                    group: 'links',
                    onEnd: function(evt) {
                        var catIndex = parseInt(evt.from.dataset.catIndex, 10);
                        var oldIndex = evt.oldIndex;
                        var newIndex = evt.newIndex;

                        var category = appState[catIndex];
                        if (category && category.liens) {
                            var movedItem = category.liens.splice(oldIndex, 1)[0];
                            category.liens.splice(newIndex, 0, movedItem);
                            render();
                        }
                    }
                });
            });
        }


        // --- Utilitaires ---

        function updateOutput() {
            // Sérialisation propre de l'état vers le champ caché
            outputField.value = JSON.stringify(appState, null, 4);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Initialisation ---

        // Bouton Ajout Catégorie Global
        btnAddCat.onclick = function() {
            appState.push({
                categorie: "",
                liens: []
            });
            render();
            // Scroll vers le bas
            setTimeout(function() {
                window.scrollTo(0, document.body.scrollHeight);
            }, 100);
        };

        // Interception finale du submit pour être sûr à 100%
        form.onsubmit = function() {
            updateOutput();
            // Vérification basique
            if (outputField.value.length < 2) {
                alert("Erreur : Les données semblent vides.");
                return false;
            }
            return true;
        };

        // Premier rendu
        render();
        console.log("Éditeur initialisé avec " + appState.length + " catégories.");

    } catch (err) {
        // Capture des erreurs synchrones dans le bloc principal
        var errorZone = document.getElementById('js-error-zone');
        errorZone.style.display = 'block';
        errorZone.innerHTML = '<strong>Erreur d\'initialisation :</strong><br>' + err.message;
        console.error(err);
    }

})();
</script>
{% endblock %}
