<!-- templates/admin/modifier.html -->
{% extends 'base.html' %}

{% block title %}Modifier un objet - Gestion de la collection{% endblock %}

{% block content %}
<section class="admin-form-section">
    <h1>Modification de la fiche</h1>

    <form method="post" enctype="multipart/form-data" class="admin-form">
        <div class="form-group">
            <label for="nom">Nom (ou titre) *</label>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="version" value="{{ objet['version'] }}">
            <input type="text" id="nom" name="nom" value="{{ objet['nom'] }}" required>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="5">{{ objet['description'] }}</textarea>
        </div>

        <div class="form-group">
            <label for="categorie">Catégorie *</label>
            <select id="categorie" name="categorie" required>
                <option value="">-- Sélectionner une catégorie --</option>
                <!-- Les options seront générées dynamiquement par JavaScript -->
            </select>
            <small>La catégorie détermine quels champs supplémentaires sont disponibles</small>
        </div>

        <div class="form-group" id="autre-categorie-container" style="display: none;">
            <label for="autre-categorie">Préciser la catégorie *</label>
            <input type="text" id="autre-categorie" name="autre-categorie" value="{{ objet['categorie'] if objet['categorie'] and objet['categorie'] not in ['Ordinateur', 'Console de jeu', 'Périphérique', 'Appareil photo'] else '' }}">
        </div>

        <div class="form-group">
            <label for="fabricant">Fabricant (ou éditeur)</label>
            <input type="text" id="fabricant" name="fabricant" value="{{ objet['fabricant'] }}">
        </div>

        <div class="form-group">
            <label for="date_fabrication">Année de sortie (ou d'édition)</label>
            <input type="text" id="date_fabrication" name="date_fabrication" value="{{ objet['date_fabrication'] }}">
        </div>

        <div class="form-group liens-supplementaires">
            <label>Informations (URL)</label>
            <div class="liens-upload-container" id="liens-container">
                {% if liens %}
                    {% for lien in liens %}
                    <div class="lien-upload-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="url" name="liens" value="{{ lien.url }}" placeholder="https://..." style="flex-grow: 1;">
                        <button type="button" class="btn-small danger" onclick="supprimerChampLien(this)">-</button>
                    </div>
                    {% endfor %}
                    <!-- Toujours avoir un bouton d'ajout à la fin, ou à côté du dernier ? 
                         Le design demande un "+" pour ajouter. On le met en bas de la liste ou sur la première ligne ? 
                         L'instruction disait "min 1 champ avec un bouton + à droite". 
                         On va ajouter un bouton global d'ajout en bas ou sur la dernière ligne.
                         Pour simplifier l'UI : chaque ligne a un "-", et on met un bouton "+" en dessous ou sur la première ligne si vide.
                    -->
                {% else %}
                    <div class="lien-upload-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="url" name="liens" placeholder="https://..." style="flex-grow: 1;">
                        <!-- Le premier champ n'a pas forcément de bouton "-" si c'est le seul, mais l'instruction dit "min 1 champ". 
                             On va laisser le bouton "-" partout pour simplifier, sauf si c'est le seul ? 
                             Non, l'instruction dit "Chaque champ supplémentaire comporte un bouton -".
                        -->
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn" style="padding: 0.4rem 1rem; font-size: 0.85rem;" onclick="ajouterChampLien()">+ Ajouter un lien</button>
            <br><small>Entrez des URL complètes (ex: https://exemple.com)</small>
        </div>

        <div class="form-group">
            <label for="numero_inventaire">Numéro d'inventaire *</label>
            <input type="text" id="numero_inventaire" name="numero_inventaire" value="{{ objet['numero_inventaire'] }}" required readonly class="readonly-input">
            <small>Ce numéro ne peut pas être modifié</small>
        </div>

            <div class="form-group">
                <label for="etat">État de l'objet</label>
                <select id="etat" name="etat" class="form-control">
                    <option value="" {% if not objet['etat'] %}selected{% endif %}>Non spécifié</option>
                    <option value="Neuf" {% if objet['etat'] == 'Neuf' %}selected{% endif %}>Neuf (jamais utilisé)</option>
                    <option value="Très bon état" {% if objet['etat'] == 'Très bon état' %}selected{% endif %}>Très bon état</option>
                    <option value="Bon état" {% if objet['etat'] == 'Bon état' %}selected{% endif %}>Bon état (traces d'usure)</option>
                    <option value="État moyen" {% if objet['etat'] == 'État moyen' %}selected{% endif %}>État moyen (fonctionnel)</option>
                    <option value="Mauvais état" {% if objet['etat'] == 'Mauvais état' %}selected{% endif %}>Mauvais état (à restaurer)</option>
                    <option value="Hors service" {% if objet['etat'] == 'Hors service' %}selected{% endif %}>Hors service / Pour pièces</option>
                </select>
            </div>

            <div class="form-group">
                <label for="origine">Origine / Donateur</label>
                <input type="text" id="origine" name="origine" class="form-control" value="{{ objet['origine']|default('') }}" placeholder="Ex: Don de M. Dupont...">
                <small class="form-help">Information confidentielle (visible uniquement par les administrateurs)</small>
            </div>

        <div class="form-group">
            <h3>Champs spécifiques à la catégorie</h3>
            <br/>
            <div id="attributs-specifiques-container">
                <!-- Les champs spécifiques seront injectés ici par JavaScript -->
            </div>
        </div>

        <div class="form-group">
            <label for="image_principale">Image principale</label>
            {% if objet['image_principale'] %}
            <div class="current-image">
                <img src="{{ url_for('static', filename=objet['image_principale']) }}" alt="Image principale actuelle" class="thumbnail">
            </div>
            {% endif %}
            <input type="file" id="image_principale" name="image_principale" accept="image/*">
            <small>Laissez vide pour conserver l'image actuelle</small>
        </div>

        <div class="form-group">
            <label>Images supplémentaires</label>
            {% if images %}
                <div class="current-images">
                    {% for image in images %}
                    <div class="current-image-item" id="image-item-{{ image['id'] }}">
                        <img src="{{ url_for('static', filename=image['chemin']) }}" alt="Image {{ loop.index }}" class="thumbnail">
                        <div class="image-controls">
                            <input type="text" name="legende_{{ image['id'] }}" value="{{ image['legende'] }}" placeholder="Légende">
                            <button type="button" class="btn-small danger delete-image-btn" onclick="marquerPourSuppression({{ image['id'] }})">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                            <!-- Champ caché pour garder trace des images à conserver -->
                            <input type="hidden" name="garder_image" value="{{ image['id'] }}" id="keep-image-{{ image['id'] }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Aucune image supplémentaires n'est actuellement associée à cet objet</p>
            {% endif %}
        </div>

        <div class="form-group">
            <label>Ajouter de nouvelles images</label>
            <div class="image-upload-container" id="nouvelles-images-container">
                <div class="image-upload-item">
                    <input type="file" name="nouvelles_images" accept="image/*">
                    <input type="text" name="nouvelle_legende_0" placeholder="Légende (optionnelle)">
                    <button type="button" class="btn-small" onclick="ajouterNouvelleImage()">+</button>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('collection') }}" class="btn secondary">Annuler</a>
            <button type="submit" class="btn primary">Enregistrer</button>
        </div>
    </form>
</section>

<script>
    // Variable pour stocker les attributs chargés depuis le JSON
    let categorieAttributs = {};

    // Fonction pour remplir le sélecteur de catégories à partir du JSON
    function remplirCategories() {
        const categorieSelect = document.getElementById('categorie');
        const categorieValue = categorieSelect.value; // Sauvegarder la valeur actuelle

        // Vider le sélecteur sauf l'option par défaut
        while (categorieSelect.options.length > 1) {
            categorieSelect.remove(1);
        }

        // Ajouter une option pour chaque catégorie du JSON
        for (const categorie in categorieAttributs) {
            const option = document.createElement('option');
            option.value = categorie;
            option.textContent = categorie;
            categorieSelect.appendChild(option);
        }

        // Ajouter l'option "Autre"
        const autreOption = document.createElement('option');
        autreOption.value = 'Autre';
        autreOption.textContent = 'Autre';
        categorieSelect.appendChild(autreOption);

        // Restaurer la valeur sélectionnée si elle existe
        if (categorieValue) {
            categorieSelect.value = categorieValue;
        }

        // Pour l'initialisation, préselectionner la catégorie si elle vient du serveur
        if ("{{ objet['categorie'] }}") {
            if (Array.from(categorieSelect.options).some(opt => opt.value === "{{ objet['categorie'] }}")) {
                categorieSelect.value = "{{ objet['categorie'] }}";
            } else if ("{{ objet['categorie'] }}" && !["", "Autre"].includes("{{ objet['categorie'] }}")) {
                categorieSelect.value = "Autre";
                document.getElementById('autre-categorie').value = "{{ objet['categorie'] }}";
                toggleAutreCategorie();
            }
        }
    }

    // Fonction pour charger les attributs depuis le fichier JSON
    async function chargerDefinitionsAttributs() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`/static/categories.json?t=${timestamp}`);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const categoriesData = await response.json();

            // Adapter au nouveau format JSON (extraire uniquement les attributs)
            categorieAttributs = {};
            for (const categorie in categoriesData) {
                if (categoriesData[categorie].attributes) {
                    categorieAttributs[categorie] = categoriesData[categorie].attributes;
                }
            }

            // Remplir le sélecteur de catégories
            remplirCategories();

            // Initialiser les champs du formulaire
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        } catch (error) {
            console.error("Erreur lors du chargement des définitions d'attributs:", error);
            // En cas d'erreur, on définit un objet vide
            categorieAttributs = {};
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        }
    }

    // Fonction pour charger les attributs spécifiques selon la catégorie
    function chargerAttributsSpecifiques() {
        const categorie = document.getElementById('categorie').value;
        const container = document.getElementById('attributs-specifiques-container');

        // Vider le conteneur
        container.innerHTML = '';

        // Gérer le cas "Autre" et les catégories sans attributs spécifiques définis
        if (categorie === 'Autre' || !categorieAttributs[categorie]) {
            container.innerHTML = '<p>Aucun attribut spécifique disponible pour cette catégorie</p>';
            return;
        }

        // Créer les champs pour chaque attribut
        categorieAttributs[categorie].forEach(attr => {
            const divElement = document.createElement('div');
            divElement.className = 'form-group';

            const labelElement = document.createElement('label');
            labelElement.setAttribute('for', `attr_${attr.id}`);
            labelElement.textContent = attr.label;

            const inputElement = document.createElement('input');
            inputElement.setAttribute('type', attr.type);
            inputElement.setAttribute('id', `attr_${attr.id}`);
            inputElement.setAttribute('name', `attr_${attr.id}`);

            // Ajouter un champ caché pour l'ordre
            const orderInput = document.createElement('input');
            orderInput.setAttribute('type', 'hidden');
            orderInput.setAttribute('name', `attr_ordre_${attr.id}`);
            orderInput.setAttribute('value', attr.ordre);

            // Ajouter un champ caché pour le label
            const labelInput = document.createElement('input');
            labelInput.setAttribute('type', 'hidden');
            labelInput.setAttribute('name', `attr_label_${attr.id}`);
            labelInput.setAttribute('value', attr.label);

            // Pour le formulaire de modification, précharger les valeurs si elles existent
            {% if objet['attributs_specifiques'] %}
            try {
                const attributsSpecifiques = JSON.parse({{ objet["attributs_specifiques"]|tojson|safe }});
                if (attributsSpecifiques && attributsSpecifiques[attr.id]) {
                    // On vérifie si c'est un objet ou une simple valeur
                    if (typeof attributsSpecifiques[attr.id] === 'object' && attributsSpecifiques[attr.id] !== null) {
                        // Si c'est un objet avec une propriété 'valeur', utiliser cette valeur
                        if ('valeur' in attributsSpecifiques[attr.id]) {
                            inputElement.value = attributsSpecifiques[attr.id].valeur;
                        }
                        // Sinon, utiliser une chaîne vide pour éviter [object Object]
                        else {
                            inputElement.value = '';
                            console.warn(`Format incorrect pour l'attribut ${attr.id}:`, attributsSpecifiques[attr.id]);
                        }
                    } else {
                        // Pour les valeurs non-objet (string, number, etc.)
                        inputElement.value = attributsSpecifiques[attr.id] || '';
                    }
                }
            } catch (e) {
                console.error("Erreur lors du chargement des attributs spécifiques", e);
            }
            {% endif %}

            divElement.appendChild(labelElement);
            divElement.appendChild(inputElement);
            divElement.appendChild(orderInput);
            divElement.appendChild(labelInput);
            container.appendChild(divElement);
        });
    }

    // Gérer l'affichage du champ "Autre catégorie"
    function toggleAutreCategorie() {
        const categorieSelect = document.getElementById('categorie');
        const autreCategorieContainer = document.getElementById('autre-categorie-container');

        if (categorieSelect.value === 'Autre') {
            autreCategorieContainer.style.display = 'block';
            document.getElementById('autre-categorie').setAttribute('required', 'required');
        } else {
            autreCategorieContainer.style.display = 'none';
            document.getElementById('autre-categorie').removeAttribute('required');
        }
    }

    let imageIndex = 1;

    function ajouterNouvelleImage() {
        const container = document.getElementById('nouvelles-images-container');
        const newItem = document.createElement('div');
        newItem.className = 'image-upload-item';

        newItem.innerHTML = `
            <input type="file" name="nouvelles_images" accept="image/*">
            <input type="text" name="nouvelle_legende_${imageIndex}" placeholder="Légende (optionnelle)">
            <button type="button" class="btn-small danger" onclick="supprimerNouvelleImage(this)">-</button>
        `;

        container.appendChild(newItem);
        imageIndex++;
        
        // Activer le Drag & Drop sur le nouveau champ
        if (typeof enhanceFileUploads === 'function') {
            enhanceFileUploads();
        }
    }

    function supprimerNouvelleImage(button) {
        const item = button.parentElement;
        item.remove();
    }

    function marquerPourSuppression(imageId) {
        // Masquer visuellement l'élément
        const imageItem = document.getElementById(`image-item-${imageId}`);
        imageItem.style.opacity = '0.5';
        imageItem.style.position = 'relative';

        // Ajouter un badge "À supprimer"
        const badge = document.createElement('div');
        badge.className = 'delete-badge';
        badge.innerHTML = 'À supprimer';
        imageItem.appendChild(badge);

        // Modifier le bouton pour permettre d'annuler
        const btn = imageItem.querySelector('.delete-image-btn');
        btn.innerHTML = '<i class="fas fa-undo"></i> Annuler';
        btn.classList.remove('danger');
        btn.classList.add('secondary');
        btn.setAttribute('onclick', `annulerSuppression(${imageId})`);

        // Retirer l'image de celles à conserver
        document.getElementById(`keep-image-${imageId}`).name = 'images_supprimees';
    }

    function annulerSuppression(imageId) {
        // Rétablir l'apparence normale
        const imageItem = document.getElementById(`image-item-${imageId}`);
        imageItem.style.opacity = '1';

        // Supprimer le badge
        const badge = imageItem.querySelector('.delete-badge');
        if (badge) {
            badge.remove();
        }

        // Rétablir le bouton de suppression
        const btn = imageItem.querySelector('.delete-image-btn');
        btn.innerHTML = '<i class="fas fa-trash"></i> Supprimer';
        btn.classList.add('danger');
        btn.classList.remove('secondary');
        btn.setAttribute('onclick', `marquerPourSuppression(${imageId})`);

        // Remettre l'image parmi celles à conserver
        document.getElementById(`keep-image-${imageId}`).name = 'garder_image';
    }

    // Gestion des liens dynamiques
    function ajouterChampLien() {
        const container = document.getElementById('liens-container');
        const newItem = document.createElement('div');
        newItem.className = 'lien-upload-item';
        newItem.style.cssText = "display: flex; gap: 10px; margin-bottom: 10px; align-items: center;";

        newItem.innerHTML = `
            <input type="url" name="liens" placeholder="https://..." style="flex-grow: 1;">
            <button type="button" class="btn-small danger" onclick="supprimerChampLien(this)">-</button>
        `;

        container.appendChild(newItem);
    }

    function supprimerChampLien(button) {
        const item = button.parentElement;
        item.remove();
    }

    // Initialiser les éléments au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const categorieSelect = document.getElementById('categorie');
        const form = document.querySelector('form');

        // Charger les définitions d'attributs
        chargerDefinitionsAttributs();

        // Écouter les changements de catégorie
        categorieSelect.addEventListener('change', function() {
            toggleAutreCategorie();
            chargerAttributsSpecifiques();
        });

        // Intercepter la soumission du formulaire pour gérer "Autre catégorie"
        form.addEventListener('submit', function(e) {
            if (categorieSelect.value === 'Autre') {
                const autreCategorie = document.getElementById('autre-categorie').value.trim();
                if (autreCategorie) {
                    e.preventDefault(); // Empêcher la soumission standard

                    // Créer un champ caché pour la catégorie personnalisée
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'categorie_personnalisee';
                    hiddenInput.value = autreCategorie;
                    form.appendChild(hiddenInput);

                    // Soumettre le formulaire
                    form.submit();
                }
            }
        });
    });
</script>
{% endblock %}
